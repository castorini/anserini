package io.anserini.search.query;

import ai.onnxruntime.*;
import ai.onnxruntime.OrtSession.Result;

import org.apache.commons.io.FileUtils;
import org.junit.Test;

import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

import static org.junit.Assert.assertArrayEquals;

public class SpladePlusPlusSelfDistilEncoderQueryInferenceTest {
    static private final String MODEL_URL = "https://rgw.cs.uwaterloo.ca/pyserini/data/splade-pp-sd-optimized.onnx";
    static private final String MODEL_NAME = "splade-pp-sd-optimized.onnx";

    Object[][] examples = new Object[][] {
            { new long[] { 101, 2029, 18714, 7457, 13853, 3798, 1999, 1996, 2668, 1029, 102 },
                    new long[] { 2504, 2668, 3231, 3433, 3445, 3466, 3623, 3798, 4319, 4789, 4852, 5333, 5387, 5547,
                            7077, 7461, 8247, 8319, 9007, 9495, 9997, 10032, 10163, 12005, 12448, 13004, 13341, 13853,
                            14667, 14671, 16026, 16731, 17357, 17376, 17379, 17404, 17531, 17663, 17698, 18089, 18260,
                            18714, 18888, 20752, 22991, 23216, 24054, 25937, 29610 },
                    new float[] { 0.6254993f, 1.5603197f, 0.09017385f, 0.14612699f, 1.0984323f, 0.3042718f, 1.7450445f,
                            1.0484538f, 0.15550575f, 0.03651797f, 0.8392647f, 1.1836241f, 0.099721275f, 0.17895643f,
                            0.2964426f, 0.3055787f, 0.10164611f, 0.26622358f, 0.42472848f, 0.04011469f, 0.36274952f,
                            0.0052891322f, 0.22477157f, 0.0072019016f, 0.550635f, 0.31636745f, 0.22796322f, 3.0862656f,
                            0.31209153f, 0.19684166f, 0.055169113f, 0.17269294f, 0.49208724f, 0.017470285f, 0.16942106f,
                            0.07009228f, 0.31386682f, 0.5003034f, 0.25244725f, 0.007109345f, 0.08820191f, 2.3794317f,
                            0.21154906f, 1.9676601f, 0.5407193f, 0.10120913f, 0.35485232f, 0.1440518f, 0.45879582f } },

            { new long[] { 101, 2054, 2024, 1996, 2350, 2576, 4243, 1999, 2307, 3725, 1029, 7276, 2035,
                    2008, 6611,
                    1012, 102 },
                    new long[] { 2020, 2024, 2035, 2045, 2093, 2283, 2307, 2329, 2350, 2364, 2406, 2414, 2473, 2523,
                            2536, 2563, 2576, 2602, 2698, 2759, 2862, 2866, 2885, 2922, 2945, 2967, 2983, 3003, 3032,
                            3049, 3193, 3323, 3479, 3519, 3618, 3725, 3741, 3761, 3864, 3945, 4018, 4127, 4162, 4177,
                            4243, 4314, 4331, 4428, 4574, 4603, 4707, 4750, 4775, 4784, 5347, 5454, 5768, 5981, 6056,
                            6092, 6131, 6611, 6830, 7072, 7141, 7201, 7276, 7515, 8008, 8986, 9434, 9874, 10233, 10317,
                            13815, 14926, 17117, 21127, 21277 },
                    new float[] { 0.08951428f, 0.053033922f, 0.14792134f, 0.29028207f, 0.45465478f, 1.5292934f,
                            1.6849011f, 1.129657f, 1.5305871f, 0.4933391f, 0.10604418f, 0.035553433f, 0.29644704f,
                            0.14211628f, 0.07248659f, 0.77335906f, 1.3266996f, 0.2367833f, 0.16282322f, 0.3520752f,
                            0.4165533f, 1.0882475f, 0.32702485f, 0.1721314f, 0.13243194f, 0.10122981f, 0.33493605f,
                            0.118622124f, 0.17121682f, 0.032770414f, 0.014437968f, 0.8799145f, 0.513103f, 0.16153926f,
                            0.121618554f, 1.981122f, 0.014604922f, 0.3323847f, 0.25224033f, 0.33041716f, 0.4180116f,
                            0.3267885f, 0.6800699f, 0.018318286f, 1.7389371f, 0.03220704f, 0.76414675f, 0.035492457f,
                            0.045311566f, 0.26308584f, 0.6423329f, 0.4457271f, 0.032068163f, 0.079079874f, 0.6804486f,
                            0.03237382f, 0.011425539f, 0.5562029f, 0.068335615f, 0.114160255f, 0.38404113f, 1.0646759f,
                            0.29895043f, 0.14914946f, 0.5654972f, 0.08382292f, 0.89474374f, 0.21543607f, 0.43520498f,
                            0.07715566f, 0.3808515f, 0.12593457f, 0.32912818f, 1.3347186f, 0.58818054f, 0.36245236f,
                            0.32023156f, 0.10870397f, 0.22727196f } },

            { new long[] { 101, 2054, 2828, 1997, 4736, 2515, 8611, 2227, 1999, 1051, 1010, 2888, 1996, 5592, 1997,
                    1996, 23848, 2072, 102 },
                    new long[] { 1051, 1996, 1997, 1998, 2014, 2016, 2050, 2063, 2072, 2080, 2106, 2143, 2162, 2208,
                            2227, 2265, 2377, 2442, 2466, 2643, 2645, 2767, 2806, 2828, 2839, 2888, 2954, 2964, 3117,
                            3276, 3494, 3571, 3689, 4028, 4119, 4320, 4323, 4615, 4736, 4808, 4963, 5233, 5307, 5344,
                            5394, 5436, 5592, 5722, 5961, 5981, 6326, 6580, 6907, 6925, 6954, 6965, 7089, 7195, 7401,
                            7804, 8364, 8611, 8795, 9446, 9604, 9755, 9861, 10661, 13800, 14225, 14686, 23244, 23848 },
                    new float[] { 0.6881591f, 0.48742527f, 0.34779894f, 0.00959381f, 0.1045399f, 0.48723763f,
                            0.04079369f, 0.0035249975f, 0.68595546f, 0.021728437f, 0.088211834f, 0.26805612f,
                            0.6878376f, 0.055417832f, 1.319272f, 0.06307693f, 0.11862033f, 0.14198844f, 0.8394472f,
                            0.2641761f, 0.6945087f, 0.06819266f, 0.0515429f, 0.5969274f, 0.7342607f, 1.787558f,
                            0.75223374f, 0.13224815f, 0.4527166f, 0.56249064f, 0.23100252f, 0.16374722f, 0.06510916f,
                            0.5664091f, 0.031327643f, 0.47769243f, 0.46168816f, 0.052693915f, 1.4952576f, 0.057765912f,
                            0.3566803f, 0.44336718f, 0.09133296f, 0.3120539f, 0.51553893f, 0.26438844f, 1.4483472f,
                            0.19727422f, 0.25343192f, 0.05691919f, 0.051700942f, 0.09562909f, 0.48099276f, 0.39679128f,
                            0.034273077f, 0.6400751f, 0.2704797f, 0.3910096f, 0.1747151f, 0.23553367f, 0.10676977f,
                            2.3959541f, 0.34175342f, 0.16985862f, 0.8063414f, 1.1116197f, 0.089357525f, 0.30034354f,
                            0.11123214f, 0.044479657f, 0.19887365f, 0.0409539f, 1.4240924f } },
            { new long[] { 101, 9375, 1024, 20248, 2078, 102 },
                    new long[] { 2036, 2078, 2576, 2577, 2643, 2848, 3017, 3306, 3330, 3505, 3520, 3660, 4079, 4106,
                            4172, 4775, 4787, 5074, 5215, 5237, 5253, 5297, 5449, 5529, 5557, 5616, 5624, 5639, 5726,
                            5832, 5871, 6108, 6119, 6174, 6210, 6358, 6425, 6498, 6662, 6701, 6769, 6902, 6969, 7112,
                            7150, 7232, 7240, 7291, 7344, 7366, 8129, 8325, 8475, 8785, 8991, 9036, 9168, 9180, 9183,
                            9274, 9375, 9553, 9576, 9902, 10012, 10267, 10505, 10799, 10988, 11291, 11503, 12799, 13404,
                            14085, 19240, 20137, 20248, 25546 },
                    new float[] { 0.033955444f, 2.593843f, 0.08753569f, 0.041501846f, 0.15377313f, 0.2598321f,
                            0.16626331f, 0.090945214f, 0.05444065f, 0.079775974f, 0.11970655f, 0.4749785f, 0.40814134f,
                            0.30788252f, 0.36536136f, 0.46849668f, 0.42301986f, 0.23341472f, 0.1713735f, 0.051196497f,
                            0.2038477f, 0.34754956f, 0.1511608f, 0.16337422f, 0.18586625f, 0.04542264f, 0.109486714f,
                            0.054638874f, 0.08377841f, 0.05840841f, 0.24060449f, 0.05844799f, 0.16255666f, 0.016723443f,
                            1.2975209f, 0.23732917f, 0.03029436f, 0.7531058f, 0.004609554f, 0.20371975f, 0.49340525f,
                            0.06463993f, 0.3602243f, 0.04210253f, 0.14232093f, 0.064544834f, 0.0656475f, 0.2754322f,
                            0.0062825796f, 0.27059194f, 0.24068715f, 0.0077369544f, 0.116324015f, 0.17171733f,
                            0.11325088f, 0.28380677f, 0.13635004f, 0.0133265015f, 0.52782315f, 0.30834946f, 0.36216152f,
                            0.024365729f, 0.25281328f, 0.2466939f, 0.15490507f, 0.35973167f, 0.84626126f, 0.0038016208f,
                            0.16754465f, 0.33999476f, 0.015038098f, 0.044288877f, 0.87235254f, 0.19914848f, 0.09647831f,
                            0.13485788f, 3.1588182f, 0.41351992f } },
            { new long[] { 101, 2043, 2024, 1996, 2176, 2749, 2008, 2552, 2006, 2019, 13297, 1999, 14442, 1029, 102 },
                    new long[] { 1018, 1999, 2006, 2024, 2043, 2052, 2076, 2093, 2127, 2162, 2176, 2250, 2402, 2486,
                            2552, 2574, 2597, 2617, 2693, 2698, 2749, 2895, 2929, 2948, 2954, 2991, 3058, 3153, 3194,
                            3199, 3276, 3358, 3399, 3443, 3462, 3466, 3627, 3772, 3778, 3909, 4019, 4040, 4195, 4337,
                            4403, 4405, 4490, 4668, 4742, 4853, 4894, 4946, 5584, 5670, 5703, 5823, 5876, 6119, 6192,
                            6466, 6510, 6980, 7077, 7337, 7370, 7400, 7461, 7551, 7739, 8123, 8372, 8505, 8522, 8745,
                            8992, 9396, 9575, 9963, 10146, 10595, 10763, 10984, 10988, 11099, 11352, 13212, 13297,
                            13428, 13811, 14442, 18355, 18440, 19744, 19790, 25546, 27790 },
                    new float[] { 0.87346447f, 0.026707694f, 0.07060173f, 0.25447592f, 0.8867803f, 0.09488833f,
                            0.2739716f, 0.035688832f, 0.066025645f, 0.17472862f, 1.9734064f, 0.22531253f, 0.3181824f,
                            1.5683635f, 1.1716979f, 0.19967201f, 0.3486003f, 0.14485028f, 0.22120924f, 0.10654068f,
                            2.0822432f, 0.20054856f, 0.49688947f, 1.6266139f, 0.2875595f, 0.11276793f, 1.055685f,
                            0.13203381f, 0.16952561f, 0.69100505f, 0.06912223f, 0.17011657f, 0.3840891f, 0.09744372f,
                            0.75227916f, 0.2752379f, 0.30401418f, 0.1542375f, 0.009008478f, 0.046990372f, 0.074992634f,
                            0.3222071f, 0.19358803f, 0.10604783f, 0.2962601f, 0.79131985f, 0.32516962f, 0.24941856f,
                            0.13920003f, 0.0008760429f, 0.2278482f, 1.0985837f, 0.50649285f, 0.006894963f, 0.027920563f,
                            0.69029474f, 0.4882864f, 0.13900398f, 0.032789446f, 0.20818795f, 0.08972953f, 0.0341482f,
                            0.15140888f, 0.44176516f, 0.1627203f, 0.08772701f, 0.04251642f, 0.26968953f, 0.047004018f,
                            0.16960399f, 0.2293778f, 0.0717358f, 0.19177477f, 0.14288777f, 0.7958457f, 0.012947185f,
                            0.15264882f, 0.11731637f, 0.20748335f, 0.30368605f, 0.2622052f, 0.2879965f, 0.26999125f,
                            0.09535506f, 0.017350907f, 0.24111184f, 1.8074275f, 0.31603193f, 0.1954492f, 2.2804222f,
                            0.39507073f, 0.1685461f, 0.030299796f, 0.07216922f, 0.09877006f, 0.17063394f } },
            { new long[] { 101, 2129, 2146, 2024, 2057, 9530, 15900, 6313, 2044, 2057, 4608, 1037, 3147, 1012, 1029,
                    102 },
                    new long[] { 2017, 2044, 2051, 2057, 2065, 2146, 2197, 2320, 2331, 2402, 2425, 2574, 2681, 2919,
                            2994, 3147, 3524, 3604, 3659, 4040, 4530, 4608, 4633, 5305, 5508, 5776, 5987, 6313, 6426,
                            7233, 7240, 7355, 7524, 7691, 7865, 8985, 9012, 9016, 9367, 9530, 10720, 11005, 14447,
                            15900, 17404, 19340, 19857 },
                    new float[] { 0.08932089f, 1.2156311f, 0.35586888f, 0.23622264f, 0.31129593f, 2.0024676f,
                            0.56621903f, 0.561651f, 0.05294133f, 0.6916515f, 0.14287786f, 0.49584502f, 0.19481955f,
                            0.018266201f, 0.32682487f, 1.9791691f, 0.124580875f, 0.22960457f, 0.7444756f, 0.05794435f,
                            0.039086785f, 1.1681252f, 0.16093872f, 0.5838569f, 0.041890718f, 0.11815384f, 0.09937509f,
                            1.4192653f, 0.12549536f, 0.16197559f, 0.14787197f, 0.62147427f, 0.0075482633f, 0.4494422f,
                            0.20789517f, 0.70464414f, 0.04050193f, 0.40301403f, 0.9129424f, 0.633681f, 0.050944235f,
                            0.03824062f, 0.4055815f, 1.5588272f, 0.36847797f, 0.38316536f, 0.2511742f } },
            { new long[] { 101, 1996, 7450, 2008, 21312, 1996, 13474, 2038, 1996, 2157, 2000, 2019, 4905, 2003, 1996,
                    1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 7450, 1012, 102 },
                    new long[] { 1035, 2000, 2019, 2031, 2038, 2157, 2375, 2383, 2457, 2523, 2553, 2916, 2976, 3206,
                            3323, 3350, 3423, 3425, 3627, 3648, 3672, 3818, 3827, 3841, 3860, 3946, 3979, 4028, 4047,
                            4071, 4552, 4735, 4905, 5160, 5323, 5496, 5676, 5741, 5851, 6098, 6101, 6254, 6543, 6545,
                            7450, 7868, 7979, 9347, 9559, 9619, 9861, 9870, 9964, 10528, 10799, 11075, 11302, 11537,
                            12361, 13474, 13962, 14306, 16051, 16214, 16316, 16362, 16714, 16719, 21312 },
                    new float[] { 0.09396071f, 0.39769745f, 0.042513106f, 0.2269814f, 0.095368825f, 1.2322447f,
                            0.32869506f, 0.021715607f, 0.5152474f, 0.025083171f, 0.15594402f, 1.1680392f, 0.03982239f,
                            0.20050311f, 0.41953754f, 0.2909062f, 0.6361327f, 0.26129222f, 0.42789793f, 0.46867782f,
                            0.05796201f, 0.24467783f, 0.14935215f, 0.006738794f, 0.30419606f, 0.20018943f, 0.61699235f,
                            0.0027299777f, 0.07414123f, 0.12871374f, 1.0668367f, 0.046218593f, 2.1222005f, 1.6375039f,
                            0.0064012725f, 0.23509227f, 1.1759852f, 0.06905537f, 0.16906366f, 0.2434541f, 0.037856977f,
                            0.17217967f, 0.14451411f, 0.21748354f, 2.1792097f, 0.059433725f, 0.7408165f, 0.04183493f,
                            0.39481598f, 0.34156302f, 0.27097842f, 0.37405223f, 0.096068196f, 0.30225912f, 0.2024973f,
                            0.4379292f, 0.655515f, 0.030345477f, 0.42861432f, 1.3858142f, 0.24716046f, 0.84597504f,
                            1.6881111f, 0.9923154f, 0.12707944f, 1.0717834f, 0.18505341f, 0.08917294f, 0.5392288f } },
            { new long[] { 101, 2054, 2001, 11534, 1005, 1055, 4602, 6691, 2000, 12761, 3399, 1029, 102 },
                    new long[] { 1005, 1055, 2001, 2010, 2087, 2106, 2307, 2350, 2419, 2470, 2590, 2798, 2817, 2964,
                            3003, 3041, 3044, 3112, 3117, 3145, 3166, 3213, 3278, 3350, 3399, 3418, 3562, 3818, 4045,
                            4111, 4145, 4205, 4325, 4602, 4695, 4774, 4962, 4967, 4989, 5125, 5221, 5415, 5456, 5680,
                            5857, 5875, 6152, 6344, 6622, 6685, 6691, 6789, 6825, 7155, 7156, 7240, 7366, 7403, 7551,
                            7825, 7857, 8106, 8548, 8826, 9002, 9576, 9610, 10744, 11534, 12130, 12761, 14686, 15923,
                            16719, 18275, 19852, 25274 },
                    new float[] { 0.058909904f, 0.44264722f, 0.5547063f, 0.5578455f, 0.32442185f, 0.31669247f,
                            0.05018503f, 0.3607444f, 0.0056284517f, 0.053030416f, 0.25267488f, 0.36349264f, 0.04513667f,
                            0.42993993f, 0.09619889f, 0.05469418f, 0.193728f, 0.2806862f, 0.3377984f, 0.14815418f,
                            0.13834742f, 0.03228564f, 0.6860152f, 0.1301183f, 1.3871636f, 0.0054348568f, 0.14704175f,
                            0.4469511f, 0.4166025f, 0.22993387f, 0.0450438f, 0.17880142f, 0.40717724f, 1.8417488f,
                            0.07320358f, 0.02276629f, 0.34261498f, 0.1973669f, 0.20965715f, 0.036127344f, 1.3088219f,
                            0.08005672f, 0.6672778f, 0.093699686f, 1.5751134f, 0.14820518f, 0.29321322f, 0.22242004f,
                            1.6998758f, 0.10753015f, 1.947404f, 0.306827f, 0.024230998f, 0.64549035f, 0.384802f,
                            0.2514124f, 0.30218646f, 0.100114584f, 0.1125498f, 0.069557115f, 0.12624931f, 0.82078516f,
                            0.0017118099f, 0.52363336f, 0.020557316f, 0.036975417f, 0.28882024f, 0.016758142f,
                            2.8913898f, 0.21667603f, 1.6584743f, 0.13110657f, 0.40216935f, 0.11736768f, 0.064658254f,
                            0.32257265f, 0.13293305f } },
            { new long[] { 101, 2019, 5983, 8761, 2003, 7356, 2011, 1035, 1035, 1035, 1035, 1035, 1012, 102 },
                    new long[] { 1035, 2011, 2124, 2649, 2833, 2957, 2966, 3264, 3267, 3291, 3303, 3487, 3581, 3605,
                            3829, 3969, 4225, 4265, 4295, 4308, 4340, 4521, 4649, 4656, 4789, 4963, 5177, 5182, 5248,
                            5305, 5529, 5729, 5845, 5983, 6459, 7355, 7356, 7482, 7664, 8129, 8200, 8281, 8488, 8547,
                            8690, 8715, 8738, 8761, 9012, 9415, 9762, 9895, 10000, 10318, 10840, 11063, 13899, 14671,
                            14920, 15575, 16042, 16137, 16311, 16801, 18020, 18224, 19330, 19470, 20857, 24552, 25353,
                            28935 },
                    new float[] { 0.3100883f, 0.85963166f, 0.8246962f, 1.5442219f, 0.92088574f, 0.41420078f,
                            0.61207515f, 0.15399255f, 0.08532179f, 0.3384637f, 1.1644081f, 0.021303052f, 0.31434414f,
                            1.1186635f, 0.4341656f, 0.14131375f, 0.43030187f, 0.025254054f, 0.536504f, 0.21548414f,
                            1.6410599f, 1.708117f, 0.008569846f, 0.2538119f, 0.094990455f, 0.14289688f, 0.6221649f,
                            1.6623012f, 0.2329519f, 0.05682966f, 0.030133707f, 0.052678537f, 0.6636163f, 2.5928884f,
                            0.09940963f, 0.41538033f, 2.7539566f, 0.19751269f, 0.282084f, 0.057377536f, 0.36893252f,
                            1.4176276f, 0.27100068f, 0.09512942f, 0.41553965f, 0.0015059094f, 0.19811375f, 2.1259515f,
                            0.6681324f, 0.153141f, 0.45410722f, 0.1511526f, 0.15838192f, 0.22545736f, 1.7072592f,
                            0.20288792f, 0.63309383f, 0.1293948f, 0.12978728f, 0.2541656f, 0.16769476f, 0.11449488f,
                            0.017685104f, 0.20159489f, 0.1235227f, 0.098586015f, 0.030430706f, 0.1424638f, 0.15703449f,
                            0.41056046f, 0.025669511f, 0.46992728f } },
            { new long[] { 101, 2054, 8915, 8737, 2079, 2017, 5660, 15960, 24494, 2015, 2006, 1999, 1996, 17428, 1029,
                    1998, 2005, 2129, 2146, 1029, 102 },
                    new long[] { 2006, 2015, 2051, 2146, 3524, 3819, 4658, 4679, 4860, 5660, 6240, 6243, 8434, 8670,
                            8915, 11611, 15960, 16018, 16247, 17428, 17974, 18740, 21522, 22861, 24494 },
                    new float[] { 0.5372689f, 0.60950595f, 0.5300653f, 1.0760674f, 0.041117515f, 0.103861265f,
                            1.4467152f, 0.2056868f, 1.917263f, 1.4740334f, 0.2690941f, 0.80283976f, 0.6487708f,
                            0.37672573f, 0.74145555f, 0.0899832f, 2.2210174f, 0.13413958f, 0.06689603f, 1.3880699f,
                            0.8659274f, 0.095466785f, 1.1474576f, 0.13628691f, 1.8181365f } },
            { new long[] { 101, 2029, 18672, 8844, 26450, 6740, 16896, 2006, 1996, 4942, 15782, 14289, 8017, 1042,
                    21842, 1997, 1996, 8040, 9331, 7068, 1998, 19274, 2015, 2006, 1996, 8276, 7270, 21769, 1997, 1996,
                    20368, 7946, 1029, 102 },
                    new long[] { 1042, 1996, 2006, 2284, 2316, 2318, 2391, 2597, 2609, 2721, 2849, 2958, 3244, 3295,
                            3378, 3614, 3618, 3975, 4544, 4761, 4942, 4957, 4987, 5418, 5526, 5923, 5970, 6028, 6085,
                            6462, 6466, 6647, 6650, 6740, 7068, 7077, 7270, 7337, 7940, 7946, 8017, 8040, 8276, 8560,
                            8715, 8844, 9267, 9331, 9546, 10045, 11660, 12201, 12818, 12889, 14100, 14289, 14802, 15321,
                            15782, 16054, 16896, 17359, 18672, 19274, 19395, 20368, 21754, 21769, 21842, 23413, 23851,
                            25320, 26450, 27159 },
                    new float[] { 0.19154112f, 0.18651095f, 0.16455187f, 0.18202423f, 0.29742676f, 0.030482046f,
                            0.06277772f, 0.06803052f, 0.3411213f, 0.10880224f, 0.48635226f, 0.06318717f, 0.42627564f,
                            0.48786414f, 0.40699095f, 0.39837536f, 0.5434448f, 0.30117407f, 0.1977688f, 1.1702033f,
                            0.7573074f, 0.12647635f, 0.15032387f, 0.058599886f, 0.5974301f, 0.22398587f, 0.13891268f,
                            0.19806233f, 0.33129168f, 0.56706446f, 0.37590152f, 0.16104285f, 0.9959693f, 1.3543916f,
                            0.7927623f, 0.60651284f, 0.785208f, 0.09301072f, 1.0736144f, 0.9003531f, 0.7060828f,
                            0.7166818f, 0.6231915f, 0.059400253f, 0.48248753f, 0.66902375f, 0.022912286f, 0.9376359f,
                            0.22879885f, 0.5223057f, 0.05386033f, 0.21069795f, 0.39752916f, 0.9173449f, 0.20783204f,
                            0.37216684f, 0.19353932f, 0.7161915f, 0.39131457f, 0.946826f, 0.38999435f, 0.3271738f,
                            1.2345324f, 0.91483474f, 0.19307083f, 1.1238059f, 0.26945674f, 0.6791261f, 1.1532891f,
                            0.2994387f, 0.3522259f, 0.15532349f, 1.4914014f, 0.7453375f } }
    };

    static private String getCacheDir() {
        File cacheDir = new File(System.getProperty("user.home") + "/.cache/anserini/test");
        if (!cacheDir.exists()) {
            cacheDir.mkdir();
        }
        return cacheDir.getPath();
    }

    static private Path getEncoderModelPath() throws IOException {
        File modelFile = new File(getCacheDir(), MODEL_NAME);
        FileUtils.copyURLToFile(new URL(MODEL_URL), modelFile);
        return modelFile.toPath();
    }

    @Test
    public void basic() throws OrtException, IOException {
        String modelPath = getEncoderModelPath().toString();
        try (OrtEnvironment env = OrtEnvironment.getEnvironment();
                OrtSession.SessionOptions options = new OrtSession.SessionOptions();
                OrtSession session = env.createSession(modelPath, options)) {

            for (Object[] example : examples) {
                long[] inputIds = (long[]) example[0];
                long[] expectedIdx = (long[]) example[1];
                float[] expectedWeights = (float[]) example[2];

                Map<String, OnnxTensor> inputs = new HashMap<>();
                long[][] tokenIds = new long[1][inputIds.length];
                long[][] tokenTypeIdsTensor = new long[1][inputIds.length];
                long[][] attentionMaskTensor = new long[1][inputIds.length];
                Arrays.fill(attentionMaskTensor[0], 1);
                tokenIds[0] = inputIds;
                inputs.put("input_ids", OnnxTensor.createTensor(env, tokenIds));
                inputs.put("token_type_ids", OnnxTensor.createTensor(env, tokenTypeIdsTensor));
                inputs.put("attention_mask", OnnxTensor.createTensor(env, attentionMaskTensor));
                try (Result results = session.run(inputs)) {
                    long[] indexes = (long[]) results.get("output_idx").get().getValue();
                    float[] weights = (float[]) results.get("output_weights").get().getValue();
                    assertArrayEquals(expectedIdx, indexes);
                    assertArrayEquals(expectedWeights, weights, 1e-4f);
                }
            }
        }
    }
}